geom_point(size = 5)
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=LC, ymax=UC), width=.1) +
geom_line() +
geom_point(size = 2)
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=LC, ymax=UC), width=.1) +
geom_line() +
geom_point(size = 2) + ylab("Reduce eye (%)")
glimpse(Data)
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=LC, ymax=UC), width=.1) +
geom_line() +
geom_point(size = 2) + ylab("Reduce eye (%)") + geom_point(y =ReducedEyePercentage )
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)
p
to_plot = data_frame(Treatments =levels(Data$Treatment),
y = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
to_plot = c(Treatments =levels(Data$Treatment),
y = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
to_plot = c(y = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
to_plot = c(y = 100* as.vector(inv_logit_scaled(apply(post, 2, mean)[1:4])),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
to_plot = data_frame(Treatments =levels(Data$Treatment),
y = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
?stat_summary
to_plot = data_frame(Treatments =levels(Data$Treatment),
mean = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=to_plot$Treatments, y=to_plot$mean), colour="blue")
p
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=to_plot$Treatments, y=to_plot$mean), colour="blue")
p <- ggplot(post[,1:4], aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)
p
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue")
p
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue")
p
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue") +
p +   geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue") +
?stat_summary
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue") +
p +   geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue") +
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue") +
p +   geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue")
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE) +
geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue") +
p +   geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue")
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)
p + geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue")
p + geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue")
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)
p + geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue") +
geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue") +
geom_point(aes(x=3, y=to_plot$mean[3]), colour="blue") +  geom_errorbar(aes(x=3, ymin=to_plot$ymin[3], ymax=to_plot$ymax[3] ), colour="blue") +
geom_point(aes(x=4, y=to_plot$mean[4]), colour="blue") +  geom_errorbar(aes(x=4, ymin=to_plot$ymin[4], ymax=to_plot$ymax[4] ), colour="blue")
to_plot = data_frame(Treatments =levels(Data$Treatment),
mean = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)
p + geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue") +
geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue") +
geom_point(aes(x=3, y=to_plot$mean[3]), colour="blue") +  geom_errorbar(aes(x=3, ymin=to_plot$ymin[3], ymax=to_plot$ymax[3] ), colour="blue") +
geom_point(aes(x=4, y=to_plot$mean[4]), colour="blue") +  geom_errorbar(aes(x=4, ymin=to_plot$ymin[4], ymax=to_plot$ymax[4] ), colour="blue")
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=LC, ymax=UC), width=.1) +
geom_line() +
geom_point(size = 2) + ylab("Reduce eye (%)") +
geom_point(aes(x=5.6, y=3.9), colour="blue")
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width=.1) +
geom_line() +
geom_point(size = 2) + ylab("Reduce eye (%)") +
geom_point(aes(x=5.6, y=3.9), colour="blue")
to_plot = data_frame(Treatments =levels(Data$Treatment),
mean = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, HPDI, prob = .95))[2,1:4])
to_plot
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width=.1) +
geom_line() +
geom_point(size = 2) + ylab("Reduce eye (%)") +
geom_point(aes(x=5.6, y=3.9), colour="blue")
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width=.1) +
geom_line() +
geom_point(size = 2) + ylab("Reduce eye (%)")
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width=.1) +
geom_line() +
geom_point(size = 3) + ylab("Reduce eye (%)")
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width=.1) +
geom_line() +
geom_point(size = 3) + ylab("Reduce eye (%)")
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width= .5) +
geom_line() +
geom_point(size = 3) + ylab("Reduce eye (%)")
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width= .2) +
geom_line() +
geom_point(size = 3) + ylab("Reduce eye (%)")
p + geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue", width= .2) +
geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue", width= .2) +
geom_point(aes(x=3, y=to_plot$mean[3]), colour="blue") +  geom_errorbar(aes(x=3, ymin=to_plot$ymin[3], ymax=to_plot$ymax[3] ), colour="blue", width= .2) +
geom_point(aes(x=4, y=to_plot$mean[4]), colour="blue") +  geom_errorbar(aes(x=4, ymin=to_plot$ymin[4], ymax=to_plot$ymax[4] ), colour="blue", width= .2)
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)  + ylab("Reduce eye (%)")
p + geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue", width= .2) +
geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue", width= .2) +
geom_point(aes(x=3, y=to_plot$mean[3]), colour="blue") +  geom_errorbar(aes(x=3, ymin=to_plot$ymin[3], ymax=to_plot$ymax[3] ), colour="blue", width= .2) +
geom_point(aes(x=4, y=to_plot$mean[4]), colour="blue") +  geom_errorbar(aes(x=4, ymin=to_plot$ymin[4], ymax=to_plot$ymax[4] ), colour="blue", width= .2)
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width= .2) +
geom_line() +
geom_point(size = 3) + ylab("Reduce eye (%)")
c(post$b_TreatmentDMAG_m,post$b_TreatmentDMAG_f) - c(post$b_TreatmentRNAi_m,post$b_TreatmentRNAi_m)
H1 = c(post$b_TreatmentDMAG_m,post$b_TreatmentDMAG_f) - c(post$b_TreatmentRNAi_m,post$b_TreatmentRNAi_m)
DMAG = inv_logit_scaled(c(post$b_TreatmentDMAG_m,post$b_TreatmentDMAG_f))
RNAi  =  inv_logit_scaled(c(post$b_TreatmentRNAi_m,post$b_TreatmentRNAi_m))
H1 = DMAG -  RNAi
length(which(H1 > 0)) / length(H1)
H1 = DMAG -  RNAi
length(which(H1 > 0)) / length(H1)
100 * length(which(H1 > 0)) / length(H1)
DMAG = inv_logit_scaled(post$b_TreatmentDMAG_m) +  inv_logit_scaled(post$b_TreatmentDMAG_f)
DMAG = (inv_logit_scaled(post$b_TreatmentDMAG_m) +  inv_logit_scaled(post$b_TreatmentDMAG_f))/2
RNAi  =  (inv_logit_scaled(post$b_TreatmentRNAi_m) +  inv_logit_scaled(post$b_TreatmentRNAi_f))/2
H1 = DMAG -  RNAi
100 * length(which(H1 > 0)) / length(H1)
mean(H1)
hdi(H1)
hdi(H1)[1]
hdi(H1)[1:2]
apply(post, 2, hdi)
to_plot = data_frame(Treatments =levels(Data$Treatment),
mean = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, hdi))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, hdi))[2,1:4])
to_plot
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)  + ylab("Reduce eye (%)")
p + geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue", width= .2) +
geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue", width= .2) +
geom_point(aes(x=3, y=to_plot$mean[3]), colour="blue") +  geom_errorbar(aes(x=3, ymin=to_plot$ymin[3], ymax=to_plot$ymax[3] ), colour="blue", width= .2) +
geom_point(aes(x=4, y=to_plot$mean[4]), colour="blue") +  geom_errorbar(aes(x=4, ymin=to_plot$ymin[4], ymax=to_plot$ymax[4] ), colour="blue", width= .2)
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width= .2) +
geom_line() +
geom_point(size = 3) + ylab("Reduce eye (%)")
DMAG = inv_logit_scaled(c(post$b_TreatmentDMAG_m,post$b_TreatmentDMAG_f))
RNAi  =  inv_logit_scaled(c(post$b_TreatmentRNAi_m,post$b_TreatmentRNAi_m))
H1 = DMAG -  RNAi
100 * length(which(H1 > 0)) / length(H1)
mean(H1)
hdi(H1)[1:2]
rm(list=ls()) # clean the memory
library("dplyr")
library("ggplot2")
library("ggfortify")
library("brms")
library("tidyverse")
library("readxl")
library("HDInterval")
Data <- read_excel("Dropbox/Projects_JM/Muenster/Ozge/Data.xlsx")
glimpse(Data)
Data$Treatment = factor(Data$Treatment)
levels(Data$Treatment)
levels(Data$Treatment) <- c("DMAG_m", "DMAG_f", "RNAi_m", "RNAi_f" )
levels(Data$Treatment)
Data$N_tot = Data$NormalEyeNumbers + Data$ReducedEyeNumbers
Data$Y = Data$ReducedEyeNumbers
# Run binomial model 1
bm1 <- brm(Y | trials(N_tot) ~ 0 + Treatment, family = binomial(), data = Data  )
summary(bm1)
conditional_effects(bm1, effects = "Treatment")
logit_scaled(0.5)
inv_logit_scaled(logit_scaled(0.5))
inv_logit_scaled(-4.30)
100*inv_logit_scaled(-4.30)
plot(bm1)
# Run binomial model 1
bm1 <- brm(Y | trials(N_tot) ~ 0 + Treatment, family = binomial(), data = Data, iter = 2000, warmup = 1000, chains = 4  )
summary(bm1)
conditional_effects(bm1, effects = "Treatment")
plot(bm1)
post = posterior_samples(bm1)
glimpse(post)
apply(post, 2, mean) # 2 = coloumns , 1 = rows
apply(post, 2, hdi) # 2 = coloumns , 1 = rows
to_plot = data_frame(Treatments =levels(Data$Treatment),
mean = 100* inv_logit_scaled(apply(post, 2, mean)[1:4]),
ymin= 100 *inv_logit_scaled(apply(post, 2, hdi))[1,1:4],
ymax = 100 *inv_logit_scaled(apply(post, 2, hdi))[2,1:4])
to_plot
p <- ggplot(Data, aes(x=Treatment, y=ReducedEyePercentage)) +
geom_violin(trim=FALSE)  + ylab("Reduce eye (%)")
p + geom_point(aes(x=1, y=to_plot$mean[1]), colour="blue") +  geom_errorbar(aes(x=1, ymin=to_plot$ymin[1], ymax=to_plot$ymax[1] ), colour="blue", width= .2) +
geom_point(aes(x=2, y=to_plot$mean[2]), colour="blue") +  geom_errorbar(aes(x=2, ymin=to_plot$ymin[2], ymax=to_plot$ymax[2] ), colour="blue", width= .2) +
geom_point(aes(x=3, y=to_plot$mean[3]), colour="blue") +  geom_errorbar(aes(x=3, ymin=to_plot$ymin[3], ymax=to_plot$ymax[3] ), colour="blue", width= .2) +
geom_point(aes(x=4, y=to_plot$mean[4]), colour="blue") +  geom_errorbar(aes(x=4, ymin=to_plot$ymin[4], ymax=to_plot$ymax[4] ), colour="blue", width= .2)
ggplot(to_plot, aes(x=Treatments, y=mean)) +
geom_errorbar(aes(ymin=ymin, ymax=ymax), width= .2) +
geom_line() +
geom_point(size = 3) + ylab("Reduce eye (%)")
DMAG = inv_logit_scaled(c(post$b_TreatmentDMAG_m,post$b_TreatmentDMAG_f))
RNAi  =  inv_logit_scaled(c(post$b_TreatmentRNAi_m,post$b_TreatmentRNAi_m))
H1 = DMAG -  RNAi
100 * length(which(H1 > 0)) / length(H1)
mean(H1)
hdi(H1)[1:2]
DMAG = 100* inv_logit_scaled(c(post$b_TreatmentDMAG_m,post$b_TreatmentDMAG_f))
RNAi  = 100 * inv_logit_scaled(c(post$b_TreatmentRNAi_m,post$b_TreatmentRNAi_m))
H1 = DMAG -  RNAi
100 * length(which(H1 > 0)) / length(H1)
mean(H1)
hdi(H1)[1:2]
#  reduce eyes are more common in females
H2 = 100* inv_logit_scaled(post$b_TreatmentDMAG_f) - 100* inv_logit_scaled(post$b_TreatmentDMAG_m)
100* length(which(H2 > 0 )) / length(H2)
#  reduce eyes are more common in females RNAi
H3 = 100* inv_logit_scaled(post$b_TreatmentRNAi_f) - 100* inv_logit_scaled(post$b_TreatmentRNAi_m)
100* length(which(H3 > 0 )) / length(H3)
100* length(which(H2 - H3 > 0 )) / length(H3)
# Is there
100* length(which(H2 - H3 > 0 )) / length(H2 - H3)
# are the effects of DMAG on sex differences stronger than the effects RNAi on sex differences?
100* length(which(H2 - H3 > 0 )) / length(H2 - H3)
rm(list=ls(all=TRUE))
# MODEL COMPARASION FOR GROWTH
library("brms")
library(data.table)
rm(list=ls(all=TRUE))
###########################################################################################################
# First get the data
getwd()
setwd("~/Dropbox/Jaime M/Projects_JM/FSU/Pool_manipulation/KG_git/")
center = 18
# Guppy data cleaning -----------------------------------------------------
Gdata <- read.csv("data/GuppyIPM.csv")
Kdata <- read.csv("data/KillifishIPM.csv")
Gdata$z <- Gdata$SL1_mm - center
Gdata$z1 <- Gdata$SL2_mm
Gdata <- Gdata[-which(Gdata$Sex2=="M"),]
# Make sure the non reproductive have zeros
Gdata$Recr[which(Gdata$Repr==0 & Gdata$surv ==1)] = 0
# Killifish data cleaning -------------------------------------------------
Kdata$z <- Kdata$SL1_mm - center
Kdata$z1 <- Kdata$SL2_mm
Kdata <- Kdata[-which(Kdata$Sex2=="M"),]
# Make sure the non reproductive have zeros
Kdata$Recr[which(Kdata$Repr==0 & Kdata$surv ==1)] = 0
# Normalize the covariates (killifish biomass and canopy) -----------------
Gdata$FishBiom <- Gdata$BiomassG1 + Gdata$BiomassK1
Kdata$FishBiom <- Kdata$BiomassG1 + Kdata$BiomassK1
meanC = mean(unique(c(Gdata$FishBiom, Kdata$FishBiom ) ))
sdC = sd(unique(c(Gdata$FishBiom, Kdata$FishBiom ) ))
Gdata$FishBiom <- (Gdata$FishBiom - meanC) /  sdC
Kdata$FishBiom <- (Kdata$FishBiom - meanC) /  sdC
# fish density biomass/Area
Gdata$FishDen <- Gdata$FishBiom  / Gdata$area
Kdata$FishDen <- Kdata$FishBiom  / Kdata$area
meanC = mean(unique(c(Gdata$FishDen, Kdata$FishDen ) ))
sdC = sd(unique(c(Gdata$FishDen, Kdata$FishDen ) ))
Gdata$FishDen <- (Gdata$FishDen - meanC) /  sdC
Kdata$FishDen <- (Kdata$FishDen - meanC) /  sdC
#
meanC = mean(unique(c(Gdata$canopy, Kdata$canopy) ))
sdC = sd(unique(c(Gdata$canopy, Kdata$canopy) ))
Gdata$canopy <- (Gdata$canopy - meanC) /  sdC
Kdata$canopy <- (Kdata$canopy - meanC) /  sdC
# Re-code the random effects (drainage id) --------------------------------
Kdata$stream <- factor(Kdata$Location)
levels(Kdata$stream) <- 1:length(levels(Kdata$stream))
Kdata$stream <- as.numeric(Kdata$stream)
Gdata$stream <- factor(Gdata$Location)
levels(Gdata$stream) <- 1:length(levels(Gdata$stream))
Gdata$stream <- as.numeric(Gdata$stream)
# Compare growh models ----------------------------------------------------
surv = bf(surv ~ z*NK + FishBiom + FishDen + canopy, family = bernoulli())
growth = bf(z1 ~ z*NK + FishBiom + FishDen + canopy, family = gaussian())
ModG1 = brm(z1 ~ z*NK + FishBiom + FishDen + canopy, Gdata)
ModG1 = add_criterion(ModG1, c("waic", "loo"))
ModG2 = brm(z1 ~ z*NK +  FishBiom + canopy, Gdata)
ModG2 = add_criterion(ModG2, c("waic", "loo"))
ModG3 = brm(z1 ~ z*NK +  FishDen + canopy, Gdata)
ModG3 = add_criterion(ModG3, c("waic", "loo"))
ModG4 = brm(z1 ~ z*NK +  canopy, Gdata)
ModG4 = add_criterion(ModG4, c("waic", "loo"))
loo_compare(ModG1, ModG2, ModG3, ModG4, criterion = "loo")
loo_compare( ModG2, ModG3, criterion = "loo")
loo_model_weights(ModG1, ModG2, ModG3, ModG4, criterion = "loo")
summary(ModG1)
summary(ModG2)
pp_check(ModG1, nsamples = 100)
pp_check(ModG2, nsamples = 100)
ModK1 = brm(z1 ~ z*NG + FishBiom + FishDen + canopy, Kdata)
ModK1 = add_criterion(ModK1, c("waic", "loo"))
ModK2 = brm(z1 ~ z*NG +  FishBiom + canopy, Kdata)
ModK2 = add_criterion(ModK2, c("waic", "loo"))
ModK3 = brm(z1 ~ z*NG +  FishDen + canopy, Kdata)
ModK3 = add_criterion(ModK3, c("waic", "loo"))
ModK4 = brm(z1 ~ z*NG +  canopy, Kdata)
ModK4 = add_criterion(ModK4, c("waic", "loo"), moment_match = TRUE)
loo_compare(ModK1, ModK2, ModK3, ModK4, criterion = "loo")
ModK4 = add_criterion(ModK4, c("waic", "loo"), moment_match = TRUE)
loo_compare(ModK1, ModK2, ModK3, ModK4, criterion = "loo")
ModK4 = brm(z1 ~ z*NG +  canopy, Kdata)
ModK4 = add_criterion(ModK4, c("waic", "loo"))
loo_compare(ModK1, ModK2, ModK3, ModK4, criterion = "loo")
####
library(rethinking)
library(data.table)
rm(list=ls(all=TRUE))
# Functions
LOS <- function(x=NULL){
out =   (length(which(x > 0)) / length(x))*100
return(round(out, 3))
}
###########################################################################################################
# First get the data
getwd()
setwd("~/Dropbox/Jaime M/Projects_JM/FSU/Pool_manipulation/KG_git/")
center = 18
# Guppy data cleaning -----------------------------------------------------
Gdata <- read.csv("data/GuppyIPM.csv")
Kdata <- read.csv("data/KillifishIPM.csv")
Gdata$z <- Gdata$SL1_mm - center
Gdata$z1 <- Gdata$SL2_mm
Gdata <- Gdata[-which(Gdata$Sex2=="M"),]
# Make sure the non reproductive have zeros
Gdata$Recr[which(Gdata$Repr==0 & Gdata$surv ==1)] = 0
# Killifish data cleaning -------------------------------------------------
Kdata$z <- Kdata$SL1_mm - center
Kdata$z1 <- Kdata$SL2_mm
Kdata <- Kdata[-which(Kdata$Sex2=="M"),]
# Make sure the non reproductive have zeros
Kdata$Recr[which(Kdata$Repr==0 & Kdata$surv ==1)] = 0
# Normalize the covariates (killifish biomass and canopy) -----------------
Gdata$FishBiom <- Gdata$BiomassG1 + Gdata$BiomassK1
Kdata$FishBiom <- Kdata$BiomassG1 + Kdata$BiomassK1
meanC = mean(unique(c(Gdata$FishBiom, Kdata$FishBiom ) ))
sdC = sd(unique(c(Gdata$FishBiom, Kdata$FishBiom ) ))
Gdata$FishBiom <- (Gdata$FishBiom - meanC) /  sdC
Kdata$FishBiom <- (Kdata$FishBiom - meanC) /  sdC
# fish density biomass/Area
Gdata$FishDen <- Gdata$FishBiom  / Gdata$area
Kdata$FishDen <- Kdata$FishBiom  / Kdata$area
meanC = mean(unique(c(Gdata$FishDen, Kdata$FishDen ) ))
sdC = sd(unique(c(Gdata$FishDen, Kdata$FishDen ) ))
Gdata$FishDen <- (Gdata$FishDen - meanC) /  sdC
Kdata$FishDen <- (Kdata$FishDen - meanC) /  sdC
#
meanC = mean(unique(c(Gdata$canopy, Kdata$canopy) ))
sdC = sd(unique(c(Gdata$canopy, Kdata$canopy) ))
Gdata$canopy <- (Gdata$canopy - meanC) /  sdC
Kdata$canopy <- (Kdata$canopy - meanC) /  sdC
# Re-code the random effects (drainage id) --------------------------------
Kdata$stream <- factor(Kdata$Location)
levels(Kdata$stream) <- 1:length(levels(Kdata$stream))
Kdata$stream <- as.numeric(Kdata$stream)
Gdata$stream <- factor(Gdata$Location)
levels(Gdata$stream) <- 1:length(levels(Gdata$stream))
Gdata$stream <- as.numeric(Gdata$stream)
Gdata$growth = log(Gdata$SL2_mm/Gdata$SL1_mm)
Kdata$growth = log(Kdata$SL2_mm/Kdata$SL1_mm)
# Collect the data for the stan model -------------------------------------
data_stan = list(
# size of the variables (n) -----------------------------------------------
N_survG = length(Gdata$surv),
N_growG = length(which(Gdata$surv ==1)),
N_repG = length(which(Gdata$surv ==1)),
N_recrG = length(which(Gdata$Repr ==1)),
N_survK = length(Kdata$surv),
N_growK = length(which(Kdata$surv ==1)),
N_repK = length(which(Kdata$surv ==1)),
N_recrK = length(which(Kdata$Repr ==1)),
N_stream =  length(unique(Gdata$stream)),
# Guppy: survival data ----------------------------------------------------
Surv_G = Gdata$surv,
z_survG = Gdata$z,
NK_survG = Gdata$NK,
stream_survG = Gdata$stream,
canopy_survG = Gdata$canopy,
BK1_survG = Gdata$K1s,
BK2_survG = Gdata$K2s,
BG1_survG = Gdata$G1s,
BG2_survG = Gdata$G2s,
FB_survG = Gdata$FishDen,
# Guppy: growth -----------------------------------------------------------
z1_G   = Gdata$z1[which(Gdata$surv ==1)],
z_growG = Gdata$z[which(Gdata$surv ==1)],
NK_growG = Gdata$NK[which(Gdata$surv ==1)],
stream_growG = Gdata$stream[which(Gdata$surv ==1)],
canopy_growG = Gdata$canopy[which(Gdata$surv ==1)],
BK1_growG = Gdata$K1s[which(Gdata$surv ==1)],
BK2_growG = Gdata$K2s[which(Gdata$surv ==1)],
BG1_growG = Gdata$G1s[which(Gdata$surv ==1)],
BG2_growG = Gdata$G2s[which(Gdata$surv ==1)],
FB_growG = Gdata$FishDen[which(Gdata$surv ==1)],
# Guppy: Reproduction data ------------------------------------------------
Recr_G = Gdata$Recr[which(Gdata$Repr ==1)],
z_recrG = Gdata$z[which(Gdata$Repr ==1)],
NK_recrG = Gdata$NK[which(Gdata$Repr ==1)],
stream_recrG = Gdata$stream[which(Gdata$Repr ==1)],
canopy_recrG = Gdata$canopy[which(Gdata$Repr ==1)],
BK1_recrG = Gdata$K1s[which(Gdata$Repr ==1)],
BK2_recrG = Gdata$K2s[which(Gdata$Repr ==1)],
BG1_recrG = Gdata$G1s[which(Gdata$Repr ==1)],
BG2_recrG = Gdata$G2s[which(Gdata$Repr ==1)],
FB_recrG = Gdata$FishDen[which(Gdata$Repr ==1)],
# Killifish: survival data ------------------------------------------------
Surv_K = Kdata$surv,
z_survK = Kdata$z,
NG_survK = Kdata$NG,
stream_survK = Kdata$stream,
canopy_survK = Kdata$canopy,
BK1_survK = Kdata$K1s,
BK2_survK = Kdata$K2s,
BG1_survK = Kdata$G1s,
BG2_survK = Kdata$G2s,
FB_survK = Kdata$FishDen,
# Killifish: growth data --------------------------------------------------
z1_K   = Kdata$z1[which(Kdata$surv ==1)],
z_growK = Kdata$z[which(Kdata$surv ==1)],
NG_growK = Kdata$NG[which(Kdata$surv ==1)],
stream_growK = Kdata$stream[which(Kdata$surv ==1)],
canopy_growK = Kdata$canopy[which(Kdata$surv ==1)],
BK1_growK = Kdata$K1s[which(Kdata$surv ==1)],
BK2_growK = Kdata$K2s[which(Kdata$surv ==1)],
BG1_growK = Kdata$G1s[which(Kdata$surv ==1)],
BG2_growK = Kdata$G2s[which(Kdata$surv ==1)],
FB_growK = Kdata$FishDen[which(Kdata$surv ==1)],
# Killifish: Reproduction data --------------------------------------------
Recr_K = Kdata$Recr[which(Kdata$Repr ==1)],
z_recrK = Kdata$z[which(Kdata$Repr ==1)],
NG_recrK = Kdata$NG[which(Kdata$Repr ==1)],
stream_recrK = Kdata$stream[which(Kdata$Repr ==1)],
canopy_recrK = Kdata$canopy[which(Kdata$Repr ==1)],
BK1_recrK = Kdata$K1s[which(Kdata$Repr ==1)],
BK2_recrK = Kdata$K2s[which(Kdata$Repr ==1)],
BG1_recrK = Kdata$G1s[which(Kdata$Repr ==1)],
BG2_recrK = Kdata$G2s[which(Kdata$Repr ==1)],
FB_recrK = Kdata$FishDen[which(Kdata$Repr ==1)]
)
#
modG = stan("R/models/pool_mod.stan", data = data_stan, cores = 4, chains = 4,
iter = 6000, warmup = 4500, control = list(adapt_delta = 0.92, max_treedepth = 12))
saveRDS(modG, "outputs/Model_KG.RDS")
modG = readRDS("outputs/Model_KG.RDS")
sum = as.data.frame(precis(modG, digits = 5, prob = .95, depth = 2))
sum$Pars = rownames(sum)
precis(modG, digits = 5, prob = .95, depth = 2)
#traceplot_ulam(modG)
#
post <- as.data.frame(extract(modG))
write.csv(as.data.frame(post), "outputs/Posteriors.csv")
PP = as.vector(apply(as.data.frame(post), 2, LOS))
PP
names(post)
model.summary <- as.data.frame(precis(modG, prob = .95, digits = 3, depth = 3))
model.summary$LOS_l = PP[-which(names(post) == "lp__")]
model.summary$LOS_u = 100 - model.summary$LOS_l
model.summary[model.summary$`2.5%` > 0,]
model.summary[model.summary$`97.5%` < 0,]
model.summary[model.summary$LOS_l > 95,]
model.summary[model.summary$LOS_l < 5,]
write.csv(model.summary, "outputs/Model_sum.csv")
model.summary[model.summary$`2.5%` > 0,]
model.summary[model.summary$`97.5%` < 0,]
model.summary[model.summary$LOS_l < 5,]
model.summary[model.summary$LOS_l > 95,]
